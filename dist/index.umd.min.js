!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("lodash"),require("ajv"),require("antd"),require("classnames")):"function"==typeof define&&define.amd?define(["exports","react","lodash","ajv","antd","classnames"],t):t((e=e||self).ksSchemaForm={},e.React,e._,e.Ajv,e.antd,e.cln)}(this,(function(e,t,r,n,a,i){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var r=0;t.length>r;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),e}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function m(e,t,r){return(m=d()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var a=new(Function.bind.apply(e,n));return r&&f(a,r.prototype),a}).apply(null,arguments)}function p(e){var t="function"==typeof Map?new Map:void 0;return(p=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return m(e,arguments,h(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),f(r,e)})(e)}function v(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function y(e){var t=d();return function(){var r,n=h(e);if(t){var a=h(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return v(this,r)}}function g(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],n=!0,a=!1,i=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{n||null==u.return||u.return()}finally{if(a)throw i}}return r}(e,t)||b(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function b(e,t){if(e){if("string"==typeof e)return w(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?w(e,t):void 0}}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);t>r;r++)n[r]=e[r];return n}function _(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=b(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return e.length>n?{done:!1,value:e[n++]}:{done:!0}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,u=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return o=e.done,e},e:function(e){u=!0,i=e},f:function(){try{o||null==r.return||r.return()}finally{if(u)throw i}}}}t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n,i=i&&i.hasOwnProperty("default")?i.default:i;var E={"false schema":"布尔模式出错",$ref:"无法找到引用{ref}",additionalItems:"不允许超过{ref}",additionalProperties:"不允许有额外的属性",anyOf:"数据应为 anyOf 所指定的其中一个",dependencies:"应当拥有属性{property}的依赖属性{deps}",enum:"应当是预设定的枚举值之一",format:'应当匹配格式 "{format}"',type:"类型应当是 {type}",required:"必填项",maxLength:"至多 {limit} 个字符",minLength:"至少 {limit} 个字符以上",minimum:"必须 {comparison}{limit}",formatMinimum:"必须 {comparison}{limit}",maximum:"必须 {comparison}{limit}",formatMaximum:"必须 {comparison}{limit}",maxItems:"不应多于 {limit} 个项",minItems:"不应少于 {limit} 个项",maxProperties:"不应多于 {limit} 个属性",minProperties:"不应少于 {limit} 个属性",multipleOf:"应当是 {multipleOf} 的整数倍",not:'不应当匹配 "not" schema',oneOf:'只能匹配一个 "oneOf" 中的 schema',pattern:"数据格式不正确",uniqueItems:"不应当含有重复项 (第 {j} 项与第 {i} 项是重复的)",custom:"格式不正确",propertyNames:'属性名 "{propertyName}" 无效',patternRequired:"应当有属性匹配模式 {missingPattern}",switch:'由于 {caseIndex} 失败，未通过 "switch" 校验',const:"应当等于常量",contains:"应当包含一个有效项",formatExclusiveMaximum:"formatExclusiveMaximum 应当是布尔值",formatExclusiveMinimum:"formatExclusiveMinimum 应当是布尔值",if:'应当匹配模式 "{failingKeyword}"'},k=function(){function e(t){var r;o(this,e),this._properties={},this._values={},this._initValues={},this._validateOnChange=!1;var n=(t||{}).schema;this._schema=n||{},this._initValues=(null==n?void 0:n.default)||{},this._onChange=null==n||null===(r=n.ui)||void 0===r?void 0:r.onChange}return s(e,[{key:"addProperty",value:function(e,t){this._properties[e]=t}},{key:"getProperty",value:function(e){return this._properties[e]}},{key:"removeProperty",value:function(e){delete this._properties[e]}},{key:"getValues",value:function(){return this._values}},{key:"setValues",value:function(e){r.merge(this._values,e);for(var t=0,n=Object.values(this._properties);n.length>t;t++){n[t].update()}this._validateOnChange&&this.validates(),this._onChange&&this._onChange(this._values)}},{key:"setValue",value:function(e,t){r.set(this._values,e,t),this._validateOnChange&&this.validates(),this._onChange&&this._onChange(this._values)}},{key:"resetValues",value:function(){this._values=r.cloneDeep(this._initValues);for(var e=0,t=Object.values(this._properties);t.length>e;e++){t[e].reset()}this._onChange&&this._onChange(this._values)}},{key:"validates",value:function(){for(var e,t,a=0,i=Object.values(this._properties);i.length>a;a++){i[a].resetError()}var o=new n({errorDataPath:"property",allErrors:!0}),u=o.validate(this._schema,this._values);if(!u){var s,l=_(o.errors||[]);try{for(l.s();!(s=l.n()).done;){var c=s.value,h=c.dataPath,f=void 0===h?"":h,d=c.keyword,m=void 0===d?"":d,p=c.params,v=this.getProperty(null==f?void 0:f.slice(1));if(v){var y;r.templateSettings.interpolate=/{([\s\S]+?)}/g;var g=r.merge({},E,null===(y=this.schema.ui)||void 0===y?void 0:y.errors),b=r.template(g[m])(p);v.setKeywordError(m,b)}}}catch(e){l.e(e)}finally{l.f()}}var w=Object.values(this._properties).map((function(e){return e.validate()})).every(Boolean),k=!(null===(e=this.schema.ui)||void 0===e?void 0:e.onValidate)||(null===(t=this.schema.ui)||void 0===t?void 0:t.onValidate(this._values)),C=u&&w&&k;return this._validateOnChange=!C,C}},{key:"getValue",value:function(e){return r.get(this._values,e)}},{key:"schema",get:function(){return this._schema}}]),e}(),C=t.createContext(new k),P=function(){function e(t){o(this,e),this._grid=t||{}}return s(e,[{key:"grid",get:function(){return this._grid}}]),e}(),S=t.createContext(new P),x=new(function(){function e(){o(this,e),this._memo={},this._sf={}}return s(e,[{key:"register",value:function(e,t){this._memo[e]=t}},{key:"setDefault",value:function(e){this._default=e}},{key:"has",value:function(e){return this._memo.hasOwnProperty(e)}},{key:"get",value:function(e){return this.has(e)?this._memo[e]:this._default}},{key:"registrySF",value:function(e,t){this._sf[e]=t}},{key:"getSF",value:function(e){if(!this.hasSF(e))throw Error("组件".concat(e,"未注册，未引入相关文件"));return this._sf[e]}},{key:"hasSF",value:function(e){return this._sf.hasOwnProperty(e)}}]),e}());function O(e,r,n){var a,i=(null===(a=e.ui)||void 0===a?void 0:a.widget)||e.type||"",o=x.get(i);return o?t.createElement(o,{key:r,schema:e,path:r,parent:n}):null}var j=function(e,t){return t.includes(Object.prototype.toString.call(e).slice(8,-1).toLowerCase())},N=function(){function e(t,r,n){o(this,e),this.showError=!1;var a=t.schema,i=t.parent;this._path=t.path,this._parent=i,this.schema=a,this.ui=a.ui||{},this._formProperty=r,n&&(this.update=n),this.install()}return s(e,[{key:"install",value:function(){for(var e=0,t=Object.entries(this.ui);t.length>e;e++){var r=g(t[e],2),n=r[0],a=r[1];j(a,["function"])&&Object.assign(this.ui,l({},n,a.bind(this)))}this._formProperty.addProperty(this._path,this)}},{key:"uninstall",value:function(){this._formProperty.removeProperty(this._path)}},{key:"setValue",value:function(e){this._formProperty.setValue(this._path,e),this.update()}},{key:"reset",value:function(){this.schema.default&&this.setValue(this.schema.default)}},{key:"validate",value:function(){return!this.ui.onValidate||this.ui.onValidate(this._formProperty.getValues())}},{key:"setKeywordError",value:function(e,t){var r,n;this.setError((null===(r=this.ui)||void 0===r||null===(n=r.errors)||void 0===n?void 0:n[e])||t)}},{key:"setError",value:function(e){this.error=e,this.showError=!0,this.update()}},{key:"resetError",value:function(){this.showError&&(this.error="",this.showError=!1,this.update())}},{key:"setSchema",value:function(e){r.merge(this.schema,e),this.update()}},{key:"setUI",value:function(e){r.merge(this.ui,e),this.update()}},{key:"update",value:function(){}},{key:"value",get:function(){return this._formProperty.getValue(this._path)}},{key:"required",get:function(){var e,t;return null===(e=this._parent)||void 0===e||null===(t=e.required)||void 0===t?void 0:t.includes(this.propertyName)}},{key:"propertyName",get:function(){return this._path.split(".").pop()||""}},{key:"formProperty",get:function(){return this._formProperty}},{key:"path",get:function(){return this._path}}]),e}(),V=function(e){c(r,e);var t=y(r);function r(e,n){var a;return o(this,r),(a=t.call(this,e,n)).update=function(){a.forceUpdate()},a.widgetProperty=new N(e,n,a.update),a}return s(r,[{key:"componentWillUnmount",value:function(){this.widgetProperty.uninstall()}}]),r}(t.Component);function F(e){var r=g(t.useState(),2)[1],n=t.useContext(C),a=t.useMemo((function(){return new N(e,n,(function(){return r(Math.random())}))}),[]);return t.useEffect((function(){return function(){a.uninstall()}}),[]),a}V.contextType=C;var R=function(e){c(r,e);var t=y(r);function r(e){var n;return o(this,r),(n=t.call(this)).schema=e,n}return r}(p(Error)),B=new(function(){function e(){o(this,e)}return s(e,[{key:"ignoreNode",value:function(e,t){return!!["ui"].includes(e)}},{key:"getSchema",value:function(e,t){return(t=t.replace(/\[/,".[").replace(/\]/,"")).split(".").reduce((function(e,t){var r,n;return"["===t[0]?null==e||null===(r=e.items)||void 0===r?void 0:r[t.slice(1)]:null==e||null===(n=e.properties)||void 0===n?void 0:n[t]}),e)}},{key:"eliminateRef",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;if(j(t,["object"])){if(t.$ref){var n=this.parseRef(e,t.$ref);delete t.$ref,Object.assign(t,r.merge(r.cloneDeep(n),t))}for(var a=0,i=Object.entries(t);i.length>a;a++){var o=g(i[a],2),u=o[0],s=o[1];this.ignoreNode(u,s)||this.eliminateRef(e,s)}}if(j(t,["array"])){var l,c=_(t);try{for(c.s();!(l=c.n()).done;){var h=l.value;this.eliminateRef(e,h)}}catch(e){c.e(e)}finally{c.f()}}}},{key:"parseRef",value:function(e,t){var r=g(t.match(/#([^/]*)(\/.*)?/)||[],3),n=r[1],a=r[2];return n||a||console.error("invalid json schema $ref: ".concat(t)),n?this.searchSchemaById(e,"#".concat(n)):this.searchSchemaByRef(e,a)}},{key:"searchSchemaByRef",value:function(e,t){try{this.deepSearchByRef(e,t)}catch(e){return e.schema||{}}}},{key:"searchSchemaById",value:function(e,t){try{this.deepSearchById(e,t)}catch(e){return e.schema||{}}}},{key:"deepSearchByRef",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=t.replace(/\/$/,"");if(n===r)throw new R(e);if(j(e,["array","object"]))for(var a=0,i=Object.entries(e);i.length>a;a++){var o=g(i[a],2),u=o[0],s=o[1];this.ignoreNode(u,s)||this.deepSearchByRef(s,t,r+"/".concat(u))}}},{key:"deepSearchById",value:function(e,t){if(j(e,["array","object"])){if(e.$id===t)throw new R(e);for(var r=0,n=Object.entries(e);n.length>r;r++){var a=g(n[r],2),i=a[1];this.ignoreNode(a[0],i)||this.deepSearchById(i,t)}}}}]),e}()),I=t.forwardRef((function(e,r){var n=e.schema,a=n.ui||{};B.eliminateRef(n);var i=t.useRef(new k(e)).current,o=t.useRef(new P(a.grid)).current;t.useImperativeHandle(r,(function(){return i})),t.useEffect((function(){i.resetValues()}),[]);var u=Object.entries(n.properties||{}).map((function(e){var t=g(e,2);return O(t[1],"".concat(t[0]),n)})),s=x.getSF("sf");return t.createElement(C.Provider,{value:i},t.createElement(S.Provider,{value:o},t.createElement(s,a,u)))})),W=function(e){return t.createElement(a.Form,{layout:e.layout,colon:e.colon,style:e.style,className:e.className},e.children)};x.registrySF("sf",W);var A=function(e){var n=t.useContext(S),o=e.widgetProperty,u=o.schema,s=o.ui,c=o.error,h=o.showError,f=o.required,d=r.merge({},n.grid,s.grid);return t.createElement("div",{style:s.style,className:i(l({"ant-row":!0,"ant-form-item":!0,"ant-form-item-has-error":h,"ant-form-item-with-help":h},s.className||"",!0))},t.createElement(a.Col,{className:"ant-form-item-label",span:d.labelCol,style:r.merge({width:d.labelWidth||"auto",textAlign:d.labelAlign||"right"},d.labelStyle)},t.createElement("label",{title:u.title,className:i({"ant-form-item-required":f})},u.title)),t.createElement(a.Col,{className:"ant-form-item-control",span:d.controlCol,offset:d.controlOffset,style:r.merge({width:d.labelWidth||"auto"},d.labelStyle)},t.createElement("div",{className:"ant-form-item-control-input"},t.createElement("div",{className:"ant-form-item-control-input-content"},e.children)),h&&t.createElement("div",{className:"ant-form-item-explain"},t.createElement("div",null,c))))},q=function(e){var r=F(e),n=r.schema,i=r.ui;return t.createElement(A,{widgetProperty:r},t.createElement(a.Input,{value:r.value,disabled:i.disabled,maxLength:n.maxLength,placeholder:i.placeholder,defaultValue:n.default,prefix:i.prefix,suffix:i.suffix,autoComplete:i.autocomplete,autoFocus:i.autofocus,addonBefore:i.addonBefore,addonAfter:i.addonAfter,onChange:function(e){var t=e.target.value;r.setValue(t),i.onChange&&i.onChange(t)},onPressEnter:i.onEnter,onFocus:i.onFocus,onBlur:i.onBlur,style:i.style,className:i.className}))};x.register("string",q),x.setDefault(q);var M=function(e){c(n,e);var r=y(n);function n(){var e;return o(this,n),(e=r.apply(this,arguments)).onChange=function(t){e.widgetProperty.setValue(t),e.widgetProperty.ui.onChange&&e.widgetProperty.ui.onChange(t)},e}return s(n,[{key:"render",value:function(){var e=this.widgetProperty,r=e.ui;return t.createElement(A,{widgetProperty:this.widgetProperty},t.createElement(a.Select,{mode:r.mode,value:e.value,allowClear:r.allowClear||!0,disabled:r.disabled,placeholder:r.placeholder,defaultValue:e.schema.default,showSearch:r.showSearch,autoFocus:r.autofocus,onChange:this.onChange,onFocus:r.onFocus,onBlur:r.onBlur,onSearch:r.onSearch,options:r.options,style:r.style,className:r.className}))}}]),n}(V);x.register("select",M);var $=function(e){var n,a=F(e),o=a.schema,u=a.ui,s=t.useRef(new P).current,c=t.useContext(S);r.merge(s.grid,c.grid,u.grid);var h=Object.entries(o.properties||{}).map((function(t){var r=g(t,2),n=r[0];return O(r[1],"".concat(e.path,".").concat(n),o)}));return t.createElement(S.Provider,{value:s},t.createElement("div",{className:"ant-form-item"},t.createElement("div",{style:u.style,className:i(l({"ant-card":!0,"ant-card-bordered":null===(n=u.bordered)||void 0===n||n,"ant-card-hoverable":u.hoverable},u.className||"",!0))},o.title&&t.createElement("div",{className:"ant-card-head",style:r.merge({minHeight:0,fontSize:"14px",padding:"0 18px"},u.headStyle)},t.createElement("div",{className:"ant-card-head-wrapper"},t.createElement("div",{className:"ant-card-head-title",style:{padding:"8px 0"}},o.title))),t.createElement("div",{className:"ant-card-body",style:r.merge({paddingBottom:0},u.bodyStyle)},h))))};x.register("object",$);var D=function(e){var r,n=F(e),a=n.ui;return t.createElement(A,{widgetProperty:n},null===(r=a.render)||void 0===r?void 0:r.call(a,n))};x.register("custom",D);var L=function(e){var r=F(e),n=r.schema,i=r.ui;return t.createElement(A,{widgetProperty:r},t.createElement(a.InputNumber,{value:r.value,disabled:i.disabled,maxLength:n.maxLength,min:n.minimum,max:n.maximum,formatter:i.formatter,parser:i.parser,precision:i.precision,decimalSeparator:i.decimalSeparator,step:i.step,placeholder:i.placeholder,defaultValue:n.default,autoFocus:i.autofocus,onChange:function(e){r.setValue(e),i.onChange&&i.onChange(e)},onPressEnter:i.onEnter,style:i.style,className:i.className}))};x.register("number",L);var T=function(e){var r=F(e),n=r.ui;return t.createElement(A,{widgetProperty:r},t.createElement(a.Switch,{autoFocus:n.autoFocus,checked:r.value,disabled:n.disabled,defaultChecked:r.schema.default,checkedChildren:n.checkedChildren,unCheckedChildren:n.unCheckedChildren,onChange:function(e){r.setValue(e),n.onChange&&n.onChange(e)},style:n.style,className:n.className}))};x.register("boolean",T);var U=function(e){var r=F(e),n=r.ui;return t.createElement(A,{widgetProperty:r},t.createElement(a.Checkbox,{autoFocus:n.autoFocus,checked:r.value,disabled:n.disabled,defaultChecked:r.schema.default,onChange:function(e){var t=e.target.checked;r.setValue(t),n.onChange&&n.onChange(t)},style:n.style,className:n.className}))};x.register("checkbox",U);var G=function(e){var r=F(e),n=r.ui;return t.createElement(A,{widgetProperty:r},t.createElement(a.Checkbox.Group,{value:r.value,disabled:n.disabled,defaultValue:r.schema.default,onChange:function(e){r.setValue(e),n.onChange&&n.onChange(e)},options:n.options,style:n.style,className:n.className}))};x.register("checkbox.group",G),e.AntdForm=W,e.BooleanWidget=T,e.CheckBoxGroupWidget=G,e.CheckBoxWidget=U,e.CustomWidget=D,e.FormProperty=k,e.GridContext=S,e.GridProperty=P,e.NumberWidget=L,e.ObjectWidget=$,e.SF=I,e.SFContext=C,e.SFItem=A,e.SchemaError=R,e.SelectWidget=M,e.StringWidget=q,e.Widget=V,e.WidgetProperty=N,e.createWidget=O,e.schemaUtil=B,e.useWidget=F,e.widgetRegistry=x,Object.defineProperty(e,"__esModule",{value:!0})}));
